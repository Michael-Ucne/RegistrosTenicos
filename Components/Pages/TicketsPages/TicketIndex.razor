@page "/Ticket"
@inject TicketsServices ticketsService
@inject TecnicosServices tecnicosService
@inject ClientesServices clientesService
@inject NavigationManager navigationManager
@using System.Linq.Expressions
@rendermode InteractiveServer

<PageTitle>Lista de Tickets</PageTitle>

<div class="container">
    <div class="card shadow-lg">
        <div class="card-header text-center bg-primary text-white">
            <h5 class="card-title text-center">
                <strong>Consulta de Tickets</strong>
            </h5>
        </div>

        <div class="card-body">
            <div class="d-flex justify-content-end mb-2">
                <a href="@AppRoutes.TICreate" class="btn btn-success">
                    <span class="bi bi-plus-square"></span> Crear
                </a>
            </div>

            @* Filtros *@
            <div class="row">
                <div class="col-3">
                    <label class="col-form-label"><strong>Filtrar por</strong></label>
                    <InputSelect class="form-select" @bind-Value="Filtro">
                        <option value="" disabled selected>Elija una opcion</option>
                        <option value="Prioridad">Prioridad</option>
                        <option value="Cliente">Nombre Cliente</option>
                        <option value="Tecnico">Nombre Tecnico</option>
                        <option value="Asunto">Asunto</option>
                        <option value="Descripcion">Descripcion</option>
                    </InputSelect>
                </div>
                <div class="col-3">
                    <label class="col-form-label"><strong>Busqueda</strong></label>
                    <div class="input-group">
                        <input class="form-control" @bind="ValorFiltro" placeholder="Buscar" />
                        <button type="button" class="btn btn-outline-primary bi bi-search" @onclick="Buscar">Buscar</button>
                    </div>
                </div>
            </div>

            <table class="table table-striped table-hover table-bordered mt-4">
                <thead class="table text-black">
                    <tr>
                        <th>Ticket ID</th>
                        <th>Fecha</th>
                        <th>Prioridad</th>
                        <th>Cliente</th>
                        <th>Asunto</th>
                        <th>Descripcion</th>
                        <th>Tiempo Invertido</th>
                        <th>Tecnico</th>
                        <th>Editar</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var ticket in Tickets)
                    {
                        <tr>
                            <td>@ticket.TicketId</td>

                            <td>@ticket.Fecha.ToString("dd/MM/yyyy")</td>

                            <td>@prioridades[ticket.Prioridad - 1]</td>

                            <td>@Clientes.Find(c => c.ClienteId == ticket.ClienteId)?.ClienteName</td>

                            <td>@ticket.Asunto</td>

                            <td>@ticket.Descripcion</td>

                            <td>@ticket.TiempoInvertido</td>

                            <td>@Tecnicos.Find(t => t.TecnicoId == ticket.TecnicoId)?.TecnicoName</td>

                            <td class="text-center">
                                <a href="@AppRoutes.TIEdit/@ticket.TicketId" class="btn btn-outline-primary bi bi-pencil-square"></a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    public string Filtro { get; set; } = string.Empty;
    public string ValorFiltro { get; set; } = string.Empty;

    public List<Tickets> Tickets { get; set; } = new List<Tickets>();
    public List<Tecnicos> Tecnicos { get; set; } = new List<Tecnicos>();
    public List<Clientes> Clientes { get; set; } = new List<Clientes>();

    public List<string> prioridades = new List<string> { "Baja", "Media", "Alta"};

    protected override async Task OnInitializedAsync()
    {
        Tickets = await ticketsService.Listar(t => t.TicketId > 0);
        Clientes = await clientesService.Listar(c => c.ClienteId > 0);
        Tecnicos = await tecnicosService.Listar(t => t.TecnicoId > 0);
    }

    public async Task Buscar()
    {
        if (Filtro == "Id")
        {
            Tickets = await ticketsService.Listar(t => t.TicketId.ToString().Contains(ValorFiltro));
        }
        else if (Filtro == "Asunto")
        {
            Tickets = await ticketsService.Listar(t => t.Asunto.Contains(ValorFiltro));
        }
        else if (Filtro == "Cliente")
        {
            Tickets = await ticketsService.Listar(t => Clientes.Find(c => c.ClienteName == ValorFiltro).ClienteId == t.ClienteId);
        }
        else if (Filtro == "Tecnico")
        {
            Tickets = await ticketsService.Listar(t => Tecnicos.Find(c => c.TecnicoName == ValorFiltro).TecnicoId == t.TecnicoId);
        }
    }
}